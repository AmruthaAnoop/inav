#!/bin/bash

# Production Deployment Checklist

echo "================================"
echo "  PRODUCTION DEPLOYMENT GUIDE"
echo "================================"
echo ""

# Pre-deployment checks
echo "üîç PRE-DEPLOYMENT CHECKS"
echo "======================="
echo ""
echo "Before deploying, ensure:"
echo "  ‚úì All tests pass: npm test"
echo "  ‚úì Linting clean: npm run lint"
echo "  ‚úì Build succeeds: npm run build"
echo "  ‚úì All dependencies updated"
echo "  ‚úì Environment variables configured"
echo "  ‚úì Database backups created"
echo "  ‚úì SSL certificates ready"
echo "  ‚úì Monitoring tools configured"
echo ""

# Environment configuration
echo "‚öôÔ∏è  ENVIRONMENT CONFIGURATION"
echo "==========================="
echo ""
echo "Create production .env:"
echo "  NODE_ENV=production"
echo "  PORT=5000"
echo "  DB_HOST=production-db-host"
echo "  DB_USER=production-db-user"
echo "  DB_PASSWORD=<strong-password>"
echo "  DB_NAME=payment_collection_db"
echo "  JWT_SECRET=<strong-secret>"
echo "  CORS_ORIGIN=https://yourdomain.com"
echo ""

# EC2 Deployment
echo "‚òÅÔ∏è  AWS EC2 DEPLOYMENT"
echo "===================="
echo ""
echo "1. SSH into instance:"
echo "   ssh -i your-key.pem ubuntu@your-ec2-ip"
echo ""
echo "2. Run deployment script:"
echo "   chmod +x deploy.sh"
echo "   ./deploy.sh"
echo ""
echo "3. Verify deployment:"
echo "   pm2 status"
echo "   pm2 logs payment-backend"
echo "   curl http://localhost:5000/api/health"
echo ""

# SSL Setup
echo "üîí SSL CERTIFICATE SETUP"
echo "========================"
echo ""
echo "Install Certbot:"
echo "  sudo apt-get install certbot python3-certbot-nginx"
echo ""
echo "Create certificate:"
echo "  sudo certbot --nginx -d yourdomain.com"
echo ""
echo "Automatic renewal:"
echo "  sudo systemctl enable certbot.timer"
echo ""

# Monitoring
echo "üìä MONITORING SETUP"
echo "=================="
echo ""
echo "Setup PM2 Monitoring:"
echo "  pm2 install pm2-auto-pull"
echo "  pm2 save"
echo "  sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup"
echo ""
echo "View logs:"
echo "  pm2 logs payment-backend"
echo "  pm2 monit"
echo ""

# Backup
echo "üíæ DATABASE BACKUP"
echo "=================="
echo ""
echo "Create backup:"
echo "  ./backup-database.sh"
echo ""
echo "Schedule automatic backups:"
echo "  crontab -e"
echo "  0 2 * * * /path/to/backup-database.sh"
echo ""

# Post-deployment
echo "‚úÖ POST-DEPLOYMENT VERIFICATION"
echo "=============================="
echo ""
echo "1. Test API endpoints:"
echo "   curl https://yourdomain.com/api/health"
echo ""
echo "2. Monitor performance:"
echo "   pm2 monit"
echo "   top"
echo ""
echo "3. Check logs:"
echo "   pm2 logs payment-backend"
echo ""
echo "4. Test critical flows:"
echo "   - Create payment"
echo "   - Get customer details"
echo "   - Get payment history"
echo ""

# Rollback
echo "üîÑ ROLLBACK PROCEDURE"
echo "==================="
echo ""
echo "If deployment fails:"
echo "  1. Stop application: pm2 stop payment-backend"
echo "  2. Revert code: git revert <commit-hash>"
echo "  3. Restart: pm2 start payment-backend"
echo "  4. Verify: curl https://yourdomain.com/api/health"
echo ""

# Maintenance
echo "üõ†Ô∏è  ONGOING MAINTENANCE"
echo "===================="
echo ""
echo "Daily:"
echo "  - Monitor logs"
echo "  - Check disk space"
echo "  - Monitor CPU/Memory"
echo ""
echo "Weekly:"
echo "  - Review error logs"
echo "  - Check database size"
echo "  - Test backups"
echo ""
echo "Monthly:"
echo "  - Update dependencies"
echo "  - Review security"
echo "  - Performance analysis"
echo ""

# Troubleshooting
echo "üêõ TROUBLESHOOTING"
echo "================="
echo ""
echo "High CPU usage:"
echo "  pm2 monit"
echo "  top"
echo "  kill slow processes"
echo ""
echo "Memory leak:"
echo "  pm2 logs"
echo "  Restart application"
echo "  Check for infinite loops"
echo ""
echo "Database issues:"
echo "  sudo systemctl restart mysql"
echo "  mysql -u root -p -e 'CHECK TABLE customers;'"
echo ""

echo "‚úÖ Deployment checklist complete!"
echo ""
echo "üìñ Full documentation: README.md"
echo "üÜò Support: GitHub Issues"
